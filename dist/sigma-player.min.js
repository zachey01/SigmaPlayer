"use strict";function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var SigmaPlayer=_createClass((function e(t){var i=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(_classCallCheck(this,e),_defineProperty(this,"showSpinner",(function(){i.loadingSpinner.style.display="block"})),_defineProperty(this,"hideSpinner",(function(){i.loadingSpinner.style.display="none"})),_defineProperty(this,"showCentralPlay",(function(){i.centralPlayBtn.style.display="flex"})),_defineProperty(this,"hideCentralPlay",(function(){i.centralPlayBtn.style.display="none"})),_defineProperty(this,"formatTime",(function(e){return formatTime(e)})),_defineProperty(this,"getNetworkSpeed",(function(){return getNetworkSpeed()})),_defineProperty(this,"chooseQualityBasedOnSpeed",(function(){return chooseQualityBasedOnSpeed()})),_defineProperty(this,"getStoredQuality",(function(){return getStoredQuality()})),_defineProperty(this,"storeQuality",(function(e){storeQuality(e)})),_defineProperty(this,"getStoredSpeed",(function(){return getStoredSpeed()})),_defineProperty(this,"storeSpeed",(function(e){storeSpeed(e)})),_defineProperty(this,"updateTabIndices",(function(){var e=i.settingsMenu.parentElement.classList.contains(i.SHOW_CLASS);i.settingsMenu.querySelectorAll(".sigma__dropdown-item").forEach((function(t){t.setAttribute("tabindex",e?"0":"-1")}));var t=i.volumeContainer.classList.contains("active");i.volumeSlider&&i.volumeSlider.setAttribute("tabindex",t?"0":"-1")})),_defineProperty(this,"isMenuOpen",(function(){return i.settingsMenu&&i.settingsMenu.parentElement&&i.settingsMenu.parentElement.classList.contains(i.SHOW_CLASS)||i.volumeContainer&&i.volumeContainer.classList.contains("active")})),_defineProperty(this,"enablePlayButton",(function(){i.playBtn.disabled=!1,i.playBtn.style.opacity=1})),_defineProperty(this,"disablePlayButton",(function(){i.playBtn.disabled=!0,i.playBtn.style.opacity=.5})),_defineProperty(this,"togglePlayState",(function(){i.video.paused||i.video.ended?i.video.play().then((function(){i.playBtn.classList.add(i.IS_PLAYING_CLASS)})).catch((function(e){console.error("Error playing video:",e),i.hideSpinner()})):(i.video.pause(),i.playBtn.classList.remove(i.IS_PLAYING_CLASS))})),_defineProperty(this,"toggleFullscreen",(function(){document.fullscreenElement?i.closeFullscreen():i.openFullscreen()})),_defineProperty(this,"openFullscreen",(function(){i.videoWrapper.requestFullscreen?i.videoWrapper.requestFullscreen():i.videoWrapper.webkitRequestFullscreen?i.videoWrapper.webkitRequestFullscreen():i.videoWrapper.msRequestFullscreen&&i.videoWrapper.msRequestFullscreen(),i.fullScreenBtn.classList.add(i.IS_FULLSCREEN_CLASS),i.video.style.position="absolute",i.video.style.top="50%",i.video.style.left="50%",i.video.style.transform="translate(-50%, -50%)",i.video.style.maxWidth="100%",i.video.style.maxHeight="100%"})),_defineProperty(this,"closeFullscreen",(function(){document.fullscreenElement&&document.exitFullscreen().catch((function(e){console.error("Error exiting fullscreen:",e)})),i.fullScreenBtn.classList.remove(i.IS_FULLSCREEN_CLASS),i.video.style.position="",i.video.style.top="",i.video.style.left="",i.video.style.transform="",i.video.style.maxWidth="",i.video.style.maxHeight=""})),_defineProperty(this,"updateProgress",(function(){if(!i.isDragging&&i.video.duration){var e=i.video.currentTime/i.video.duration*100;i.progress.style.width=e+"%",i.updateTimeDisplay()}})),_defineProperty(this,"updateTimeDisplay",(function(e){var t=void 0!==e?e:i.video.currentTime,n=i.video.duration||0;i.currentTimeElem.textContent=i.formatTime(t),i.durationElem.textContent=i.formatTime(n),i.currentTimeElem.classList.add("countdown"),setTimeout((function(){return i.currentTimeElem.classList.remove("countdown")}),500)})),_defineProperty(this,"updateBuffered",(function(){if(i.video.buffered.length>0){var e=i.video.buffered.end(i.video.buffered.length-1),t=i.video.duration;if(t>0){var n=e/t*100;i.progress.parentElement.querySelector(".sigma__buffered").style.width="".concat(n,"%")}}})),_defineProperty(this,"handleTimelineClick",(function(e){if(i.video.duration){var t=i.timeline.offsetWidth,n=e.offsetX/t*i.video.duration;i.video.currentTime=n}})),_defineProperty(this,"startDrag",(function(e){i.isDragging=!0;var t=e.touches?e.touches[0].clientX:e.clientX;i.updateTimeline(t),i.showSeekTooltip(t)})),_defineProperty(this,"dragTimeline",(function(e){if(i.isDragging&&i.video.duration){var t=e.touches?e.touches[0].clientX:e.clientX;i.updateTimeline(t),i.showSeekTooltip(t)}})),_defineProperty(this,"stopDrag",(function(e){if(i.isDragging&&i.video.duration){i.isDragging=!1;var t=e.changedTouches?e.changedTouches[0].clientX:e.clientX;i.hideSeekTooltip(),i.updateTimeline(t);var n=(t-i.timeline.getBoundingClientRect().left)/i.timeline.offsetWidth*i.video.duration;i.video.currentTime=n}})),_defineProperty(this,"updateTimeline",(function(e){var t=i.timeline.getBoundingClientRect(),n=e-t.left;n<0&&(n=0),n>t.width&&(n=t.width);var s=n/t.width*100;i.progress.style.width=s+"%";var o=n/t.width*i.video.duration;i.updateTimeDisplay(o)})),_defineProperty(this,"showSeekTooltip",(function(e){var t=i.timeline.getBoundingClientRect(),n=e-t.left;n<0&&(n=0),n>t.width&&(n=t.width);var s=n/t.width*i.video.duration,o=i.formatTime(s);i.seekTooltip.textContent=o,i.seekTooltip.style.left="".concat(n,"px"),i.seekTooltip.style.display="block"})),_defineProperty(this,"hideSeekTooltip",(function(){i.seekTooltip.style.display="none"})),_defineProperty(this,"toggleVolume",(function(){i.volumeContainer.classList.toggle("active"),i.closeOtherMenus("volume"),i.updateTabIndices()})),_defineProperty(this,"toggleSettingsMenuFunc",(function(e){e.stopPropagation(),i.settingsMenu.parentElement.classList.toggle(i.SHOW_CLASS),i.closeOtherMenus("settings"),i.updateTabIndices()})),_defineProperty(this,"setPlaybackSpeed",(function(e){i.video.playbackRate=e,i.storeSpeed(e)})),_defineProperty(this,"checkPlayButton",(function(){i.playEnabled?i.enablePlayButton():i.disablePlayButton()})),_defineProperty(this,"closeOtherMenus",(function(e){"settings"===e?i.volumeContainer.classList.contains("active")&&i.volumeContainer.classList.remove("active"):"volume"===e&&i.settingsMenu.parentElement.classList.contains(i.SHOW_CLASS)&&i.settingsMenu.parentElement.classList.remove(i.SHOW_CLASS),i.updateTabIndices()})),this.video="string"==typeof t?document.querySelector(t):t,!this.video)throw new Error("Видео элемент не найден");if(!this.video.closest("#sigma__video-wrapper")){var s=document.createElement("div");s.id="sigma__video-wrapper",this.video.parentNode.insertBefore(s,this.video),s.appendChild(this.video)}var o=this.video.closest("#sigma__video-wrapper");createControlsUI(o,this),this.videoWrapper=o,this.options=n,this.videoType=n.videoType||null,this.videoSources={},this.selectedTranslation=null,this.selectedQuality=null,this.autoQuality=!1,this.hls=null,this.dashPlayer=null,this.isDragging=!1,this.playEnabled=!1,this.HIDE_CONTROLS_CLASS="sigma__hide-controls",this.IS_PLAYING_CLASS="sigma__isPlaying",this.IS_MUTED_CLASS="sigma__isMute",this.IS_FULLSCREEN_CLASS="sigma__isFullscreen",this.SHOW_CLASS="sigma__show",this.longPressTimeout=null,this.longPressActivated=!1,this.initialize(),this.options.sources&&this.loadVideoSources(this.options.sources)}));function createControlsUI(e,t){if(!e.querySelector("#sigma__controls")){var i=document.createElement("div");i.id="sigma__loading-spinner",i.className="sigma__spinner",e.appendChild(i),t.loadingSpinner=i;var n=document.createElement("button");n.id="sigma__central-play",n.className="sigma__central-play-button",n.setAttribute("tabindex","0");var s=getIcon("play-btn");s.classList.add("sigma__centralPlayIcon"),n.appendChild(s),e.appendChild(n);var o=document.createElement("div");o.id="sigma__controls-wrapper",o.className="sigma__control-wrapper";var a=document.createElement("div");a.className="sigma__controls sigma__controlsInner";var r=document.createElement("button");r.id="sigma__play-pause",r.setAttribute("tabindex","0");var d=getIcon("play");d.classList.add("sigma__playIcon");var l=getIcon("pause");l.classList.add("sigma__pauseIcon"),r.appendChild(d),r.appendChild(l),a.appendChild(r);var u=document.createElement("div");u.className="sigma__timeline-container",u.setAttribute("tabindex","0");var c=document.createElement("div");c.id="sigma__timeline",c.className="sigma__timeline-spacer";var h=document.createElement("div");h.className="sigma__full-timeline";var p=document.createElement("div");p.className="sigma__buffered";var m=document.createElement("div");m.id="sigma__progress",h.appendChild(p),h.appendChild(m),c.appendChild(h);var v=document.createElement("div");v.id="sigma__seek-tooltip",v.className="sigma__seek-tooltip",v.textContent="0:00:00",c.appendChild(v),u.appendChild(c);var y=document.createElement("span");y.id="sigma__current-time",y.textContent="0:00:00";var f=document.createElement("span");f.id="sigma__duration",f.textContent="0:00:00",u.appendChild(y),u.appendChild(document.createTextNode(" / ")),u.appendChild(f),a.appendChild(u);var g=document.createElement("div");g.className="sigma__volume-container";var S=document.createElement("button");S.id="sigma__mute",S.className="sigma__isMute",S.setAttribute("tabindex","0");var _=getIcon("volume");_.classList.add("sigma__volumeIcon");var E=getIcon("volume-mute");E.classList.add("sigma__muteIcon"),S.appendChild(_),S.appendChild(E),g.appendChild(S);var b=document.createElement("div");b.id="volume-menu",b.className="sigma__volume-dropdown";var C=document.createElement("input");C.id="sigma__volume-slider",C.type="range",C.style.writingMode="vertical-lr",C.style.direction="rtl",C.min="0",C.max="1",C.step="0.01",C.value="1",C.setAttribute("tabindex","-1"),b.appendChild(C),g.appendChild(b),a.appendChild(g);var L=document.createElement("div");L.className="sigma__dropdown";var T=document.createElement("button");T.id="sigma__settings-btn",T.setAttribute("tabindex","0");var P=getIcon("settings");P.classList.add("sigma__settingsIcon"),T.appendChild(P),L.appendChild(T);var w=document.createElement("div");w.id="sigma__settings-menu",w.className="sigma__dropdown-content";var k=document.createElement("div");k.className="sigma__settings-main";var A=document.createElement("div");A.className="sigma__dropdown-item",A.dataset.menu="speed",A.textContent="Скорость",k.appendChild(A);var I=document.createElement("div");I.className="sigma__dropdown-item",I.dataset.menu="translation",I.textContent="Озвучка",k.appendChild(I);var x=document.createElement("div");x.className="sigma__dropdown-item",x.dataset.menu="quality",x.textContent="Качество",k.appendChild(x);var M=document.createElement("div");M.className="sigma__settings-submenu",M.style.display="none",w.appendChild(k),w.appendChild(M),L.appendChild(w),a.appendChild(L),A.addEventListener("click",(function(){t.showSubmenu("speed")})),I.addEventListener("click",(function(){t.showSubmenu("translation")})),x.addEventListener("click",(function(){t.showSubmenu("quality")}));var N=document.createElement("button");N.id="sigma__full-screen",N.setAttribute("tabindex","0");var B=getIcon("fullscreen");B.classList.add("sigma__fullscreenIcon");var D=getIcon("fullscreen-exit");D.classList.add("sigma__minimiseIcon"),N.appendChild(B),N.appendChild(D),a.appendChild(N),o.appendChild(a),e.appendChild(o),t.centralPlayBtn=e.querySelector("#sigma__central-play"),t.seekTooltip=e.querySelector("#sigma__seek-tooltip"),t.videoWrapper=e,t.controls=e.querySelector("#sigma__controls-wrapper"),t.playBtn=e.querySelector("#sigma__play-pause"),t.volumeBtn=e.querySelector("#sigma__mute"),t.fullScreenBtn=N,t.timeline=e.querySelector("#sigma__timeline"),t.progress=e.querySelector("#sigma__progress"),t.currentTimeElem=e.querySelector("#sigma__current-time"),t.durationElem=e.querySelector("#sigma__duration"),t.volumeContainer=g,t.volumeMenu=b,t.volumeSlider=C,t.settingsBtn=T,t.settingsMenu=w,t.settingsMain=k,t.settingsSubmenu=M}}function formatTime(e){var t=Math.floor(e/3600),i=Math.floor(e%3600/60),n=Math.floor(e%60);return t>0?"".concat(t,":").concat(i<10?"0":"").concat(i,":").concat(n<10?"0":"").concat(n):"".concat(i,":").concat(n<10?"0":"").concat(n)}function getIcon(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("class","sigma__icon"),t.setAttribute("width","24"),t.setAttribute("height","24"),t.setAttribute("viewBox","0 0 24 24");var i=document.createElementNS("http://www.w3.org/2000/svg","use");return i.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#".concat(e)),t.appendChild(i),t}function getNetworkSpeed(){return navigator.connection&&navigator.connection.downlink?navigator.connection.downlink:5}function chooseQualityBasedOnSpeed(){var e=getNetworkSpeed();return e>5?"1080":e>2.5?"720":e>1?"480":"360"}function getStoredQuality(){return localStorage.getItem("sigma-preferredQuality")}function storeQuality(e){localStorage.setItem("sigma-preferredQuality",e)}function getStoredSpeed(){var e=localStorage.getItem("sigma-playbackSpeed");return e?parseFloat(e):1}function storeSpeed(e){localStorage.setItem("sigma-playbackSpeed",e)}SigmaPlayer.prototype.handleDoubleClick=function(e){if(!e.target.closest("#sigma__controls-wrapper")){var t=this.videoWrapper.getBoundingClientRect();e.clientX-t.left<t.width/2?this.video.currentTime=Math.max(0,this.video.currentTime-10):this.video.currentTime=Math.min(this.video.duration,this.video.currentTime+10)}},SigmaPlayer.prototype.handleMouseDown=function(e){var t=this;e.target.closest("#sigma__controls-wrapper")||(this.longPressTimeout=setTimeout((function(){t.video.playbackRate=2,t.longPressActivated=!0}),3e3))},SigmaPlayer.prototype.handleMouseUp=function(e){clearTimeout(this.longPressTimeout),this.longPressActivated&&(this.video.playbackRate=1,this.longPressActivated=!1)},SigmaPlayer.prototype.initialize=function(){var e=this;this.video.addEventListener("play",(function(){e.playBtn.classList.add(e.IS_PLAYING_CLASS),e.hideSpinner()})),this.video.addEventListener("pause",(function(){e.playBtn.classList.remove(e.IS_PLAYING_CLASS),e.hideSpinner()})),this.video.addEventListener("ended",(function(){e.playBtn.classList.remove(e.IS_PLAYING_CLASS),e.showControls(),e.hideSpinner()})),this.video.addEventListener("waiting",this.showSpinner),this.video.addEventListener("playing",this.hideSpinner),this.video.addEventListener("pause",this.showCentralPlay),this.video.addEventListener("play",this.hideCentralPlay),this.video.addEventListener("ended",this.showCentralPlay),this.disablePlayButton();var t=localStorage.getItem("volume");if(null!==t){var i=parseFloat(t);this.video.volume=i,this.volumeSlider.value=i,0===i?(this.video.muted=!0,this.volumeBtn.classList.add(this.IS_MUTED_CLASS)):(this.video.muted=!1,this.volumeBtn.classList.remove(this.IS_MUTED_CLASS))}else this.video.volume=1,this.volumeSlider.value=1;var n=this.getStoredSpeed();this.video.playbackRate=n,this.playBtn.addEventListener("click",(function(){e.playEnabled?e.togglePlayState():alert("Пожалуйста, выберите озвучку и качество перед воспроизведением.")})),this.centralPlayBtn.addEventListener("click",(function(){e.playEnabled&&e.togglePlayState()})),this.fullScreenBtn.addEventListener("click",this.toggleFullscreen),this.video.addEventListener("timeupdate",this.updateProgress),this.video.addEventListener("loadedmetadata",(function(){e.updateTimeDisplay()})),this.video.addEventListener("sigma__progress",this.updateBuffered),this.timeline.addEventListener("click",this.handleTimelineClick),this.timeline.addEventListener("mousedown",this.startDrag),document.addEventListener("mouseup",this.stopDrag),document.addEventListener("mousemove",this.dragTimeline),this.timeline.addEventListener("touchstart",this.startDrag),document.addEventListener("touchend",this.stopDrag),document.addEventListener("touchmove",this.dragTimeline),this.volumeBtn.addEventListener("click",(function(t){t.stopPropagation(),e.toggleVolume()})),document.addEventListener("click",(function(t){if(!t.target.closest(".sigma__dropdown")){var i=e.settingsMenu.parentElement;i.classList.contains(e.SHOW_CLASS)&&(i.classList.remove(e.SHOW_CLASS),e.updateTabIndices())}})),document.addEventListener("fullscreenchange",(function(){document.fullscreenElement||(e.fullScreenBtn.classList.remove(e.IS_FULLSCREEN_CLASS),e.video.style.position="",e.video.style.top="",e.video.style.left="",e.video.style.transform="",e.video.style.maxWidth="",e.video.style.maxHeight="")})),this.mouseActivityTimeout=null,this.showControls=this.showControls.bind(this),this.hideControls=this.hideControls.bind(this),this.resetMouseActivityTimeout=this.resetMouseActivityTimeout.bind(this),this.videoWrapper.addEventListener("mousemove",this.showControls),this.video.addEventListener("pause",this.showControls),this.video.addEventListener("play",this.resetMouseActivityTimeout),this.videoWrapper.addEventListener("mouseenter",this.showControls),this.videoWrapper.addEventListener("mouseleave",this.hideControls),this.controls.addEventListener("mousemove",this.showControls),this.controls.addEventListener("mouseenter",this.showControls),this.controls.addEventListener("mouseleave",this.resetMouseActivityTimeout),this.videoWrapper.addEventListener("touchstart",this.showControls),this.videoWrapper.addEventListener("touchend",(function(){setTimeout(e.hideControls,5e3)})),this.resetMouseActivityTimeout(),this.settingsBtn.addEventListener("click",this.toggleSettingsMenuFunc),this.videoWrapper.addEventListener("dblclick",this.handleDoubleClick),this.videoWrapper.addEventListener("mousedown",this.handleMouseDown),this.videoWrapper.addEventListener("touchstart",this.handleMouseDown),this.videoWrapper.addEventListener("mouseup",this.handleMouseUp),this.videoWrapper.addEventListener("touchend",this.handleMouseUp),this.videoWrapper.addEventListener("mouseleave",this.handleMouseUp),this.settingsMenu.addEventListener("keydown",(function(t){var i=Array.from(e.settingsMenu.querySelectorAll(".sigma__dropdown-item")).filter((function(e){return"0"===e.getAttribute("tabindex")}));if(0!==i.length){var n=i.indexOf(document.activeElement);if("ArrowDown"===t.key)t.preventDefault(),i[(n+1)%i.length].focus();else if("ArrowUp"===t.key){t.preventDefault(),i[(n-1+i.length)%i.length].focus()}else"Escape"===t.key&&(e.settingsMenu.parentElement.classList.remove(e.SHOW_CLASS),e.updateTabIndices(),e.settingsBtn.focus())}}))},SigmaPlayer.prototype.selectQuality=function(e){var t=this,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.video.currentTime;if(this.showSpinner(),this.autoQuality){var s=this.videoSources[this.selectedTranslation].auto;if(!s)return console.warn("Sources are not available"),void this.hideSpinner();if(this.videoType||(s.endsWith(".m3u8")?this.videoType="hls":s.endsWith(".mpd")?this.videoType="dash":this.videoType="mp4"),"hls"===this.videoType){if("undefined"==typeof Hls)return console.warn("hls.js not available"),void this.hideSpinner();s.endsWith(".m3u8")?(this.hls&&(this.hls.destroy(),this.hls=null),this.hls=new Hls({maxMaxBufferLength:30,maxBufferSize:5242880,maxBufferLength:30}),this.hls.attachMedia(this.video),this.hls.on(Hls.Events.MEDIA_ATTACHED,(function(){t.hls.loadSource(s)})),this.hls.on(Hls.Events.MANIFEST_PARSED,(function(){t.video.currentTime=n,t.video.play().catch((function(e){console.error("Error playing video:",e),t.hideSpinner()}))}))):(this.video.src=s,this.video.currentTime=n,this.video.play().catch((function(e){console.error("Error playing video:",e),t.hideSpinner()})),this.hideSpinner())}else if("dash"===this.videoType){if("undefined"==typeof dashjs)return console.warn("dash.js not available"),void this.hideSpinner();s.endsWith(".mpd")?(this.dashPlayer&&(this.dashPlayer.reset(),this.dashPlayer=null),this.dashPlayer=dashjs.MediaPlayer().create(),this.dashPlayer.initialize(this.video,s,!1),this.dashPlayer.on(dashjs.MediaPlayer.events.MANIFEST_LOADED,(function(){t.video.currentTime=n,t.video.play().catch((function(e){console.error("Error playing video:",e),t.hideSpinner()}))}))):(this.video.src=s,this.video.currentTime=n,this.video.play().catch((function(e){console.error("Error playing video:",e),t.hideSpinner()})),this.hideSpinner())}else this.video.src=s,this.video.currentTime=n,this.video.play().catch((function(e){console.error("Error playing video:",e),t.hideSpinner()})),this.hideSpinner()}else{if(!this.selectedTranslation)return console.warn("Пожалуйста, выберите озвучку перед выбором качества."),void this.hideSpinner();if(!this.videoSources[this.selectedTranslation][e])return console.warn("Выбранное качество недоступно."),void this.hideSpinner();i?(this.selectedQuality=e,this.storeQuality(e)):this.selectedQuality=e;var o=this.videoSources[this.selectedTranslation][this.selectedQuality];if(o&&o.length>0){var a=o[0];if(this.videoType||(a.endsWith(".m3u8")?this.videoType="hls":a.endsWith(".mpd")?this.videoType="dash":this.videoType="mp4"),"hls"===this.videoType){if("undefined"==typeof Hls)return console.warn("hls.js не найден"),void this.hideSpinner();a.endsWith(".m3u8")?(this.hls&&(this.hls.destroy(),this.hls=null),this.hls=new Hls({maxMaxBufferLength:30,maxBufferSize:5242880,maxBufferLength:30}),this.hls.attachMedia(this.video),this.hls.on(Hls.Events.MEDIA_ATTACHED,(function(){t.hls.loadSource(a)})),this.hls.on(Hls.Events.MANIFEST_PARSED,(function(){t.video.currentTime=n,t.video.play().catch((function(e){console.error("Error playing video:",e),t.hideSpinner()}))}))):(this.video.src=a,this.video.currentTime=n,this.video.play().catch((function(e){console.error("Error playing video:",e),t.hideSpinner()})),this.hideSpinner())}else if("dash"===this.videoType){if("undefined"==typeof dashjs)return console.warn("dash.js не найден"),void this.hideSpinner();a.endsWith(".mpd")?(this.dashPlayer&&(this.dashPlayer.reset(),this.dashPlayer=null),this.dashPlayer=dashjs.MediaPlayer().create(),this.dashPlayer.initialize(this.video,a,!1),this.dashPlayer.setAutoSwitchQuality(!1),this.dashPlayer.on(dashjs.MediaPlayer.events.MANIFEST_LOADED,(function(){t.video.currentTime=n,t.video.play().catch((function(e){console.error("Error playing video:",e),t.hideSpinner()}))}))):(this.video.src=a,this.video.currentTime=n,this.video.play().catch((function(e){console.error("Error playing video:",e),t.hideSpinner()})),this.hideSpinner())}else this.video.src=a,this.video.currentTime=n,this.video.play().catch((function(e){console.error("Error playing video:",e),t.hideSpinner()})),this.hideSpinner()}else console.warn("Не удалось установить источник видео."),this.hideSpinner()}},SigmaPlayer.prototype.selectQualityAuto=function(e){"hls"===this.videoType?this.hls&&(this.hls.currentLevel=e,this.updateAutoQualityUI(),this.storeQuality(e)):"dash"===this.videoType&&this.dashPlayer&&(-1===e?this.dashPlayer.setAutoSwitchQuality(!0):(this.dashPlayer.setAutoSwitchQuality(!1),this.dashPlayer.setQualityFor("video",e)),this.storeQuality(e))},SigmaPlayer.prototype.updateAutoQualityUI=function(){var e=this;"hls"===this.videoType&&this.hls&&this.settingsSubmenu.querySelectorAll("[data-level]").forEach((function(t){parseInt(t.dataset.level)===e.hls.currentLevel?t.classList.add("active"):t.classList.remove("active")}))},SigmaPlayer.prototype.populateQualityOptionsAuto=function(){},SigmaPlayer.prototype.populateTranslationOptions=function(){var e=Object.keys(this.videoSources),t=this.settingsMenu.querySelector(".sigma__settings-main [data-menu='translation']");if(e.length<=1){if(t&&(t.style.display="none"),1===e.length){if(this.selectedTranslation=e[0],this.autoQuality)this.populateQualityOptionsAuto(),this.selectQuality("auto",!1);else{var i=this.getStoredQuality();if(i&&this.videoSources[this.selectedTranslation][i]||(i=this.chooseQualityBasedOnSpeed()),this.videoSources[this.selectedTranslation][i])this.selectQuality(i,!1);else{var n=Object.keys(this.videoSources[this.selectedTranslation]).sort((function(e,t){return parseInt(t)-parseInt(e)}));i=n.find((function(e){return parseInt(e)<=parseInt(i)}))||n[0],this.selectQuality(i,!1)}}this.playEnabled=!0,this.enablePlayButton()}}else this.selectTranslation(e[0])},SigmaPlayer.prototype.selectTranslation=function(e){this.selectedTranslation=e,this.playEnabled=!0,this.enablePlayButton()},SigmaPlayer.prototype.loadVideoSources=function(e){if("string"==typeof e)this.autoQuality=!0,this.videoSources={default:{auto:e}};else if("object"===_typeof(e)){var t=!1;for(var i in e)if("string"==typeof e[i]){t=!0;break}t?(this.autoQuality=!1,this.videoSources={default:e}):(this.autoQuality=!1,this.videoSources=e)}this.populateTranslationOptions()},SigmaPlayer.prototype.showControls=function(){this.controls.classList.remove(this.HIDE_CONTROLS_CLASS),this.resetMouseActivityTimeout()},SigmaPlayer.prototype.hideControls=function(){this.isMenuOpen()||this.video.paused||this.video.ended||this.controls.classList.add(this.HIDE_CONTROLS_CLASS)},SigmaPlayer.prototype.resetMouseActivityTimeout=function(){var e=this;if(clearTimeout(this.mouseActivityTimeout),!this.video.paused&&!this.video.ended){var t="ontouchstart"in window?5e3:3e3;this.mouseActivityTimeout=setTimeout((function(){e.hideControls()}),t)}},SigmaPlayer.prototype.hideSubmenu=function(){this.settingsSubmenu.style.display="none",this.settingsSubmenu.innerHTML="",this.settingsMain.style.display="block"},SigmaPlayer.prototype.showSubmenu=function(e){var t=this;this.settingsMain.style.display="none",this.settingsSubmenu.style.display="block",this.settingsSubmenu.innerHTML="";var i=document.createElement("div");i.className="sigma__dropdown-item sigma__back-button";var n=getIcon("back");n.classList.add("sigma__backIcon"),i.appendChild(n),i.appendChild(document.createTextNode(" ".concat("speed"===e?"Скорость":"translation"===e?"Озвучка":"Качество"))),i.setAttribute("tabindex","0"),i.addEventListener("click",(function(){t.hideSubmenu()})),i.addEventListener("keydown",(function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),i.click())})),this.settingsSubmenu.appendChild(i),"speed"===e?this.populateSpeedSubmenu():"translation"===e?this.populateTranslationSubmenu():"quality"===e&&this.populateQualitySubmenu()},SigmaPlayer.prototype.populateSpeedSubmenu=function(){var e=this;[{speed:.5,label:"0.5x"},{speed:1,label:"1.0x"},{speed:2,label:"2.0x"}].forEach((function(t){var i=document.createElement("div");i.className="sigma__dropdown-item sigma__speed-option",i.dataset.speed=t.speed,i.textContent=t.label,i.setAttribute("tabindex","0"),i.addEventListener("click",(function(){e.setPlaybackSpeed(t.speed),e.hideSubmenu()})),i.addEventListener("keydown",(function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),i.click())})),e.settingsSubmenu.appendChild(i)}))},SigmaPlayer.prototype.populateTranslationSubmenu=function(){var e=this;Object.keys(this.videoSources).forEach((function(t){var i=document.createElement("div");i.className="sigma__dropdown-item",i.dataset.translation=t,i.textContent=t,i.setAttribute("tabindex","0"),i.addEventListener("click",(function(){e.selectTranslation(t),e.hideSubmenu()})),i.addEventListener("keydown",(function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),i.click())})),e.settingsSubmenu.appendChild(i)}))},SigmaPlayer.prototype.populateQualitySubmenu=function(){var e=this;if(this.autoQuality){if("dash"===this.videoType){if("undefined"==typeof dashjs){var t=document.createElement("div");return t.className="sigma__dropdown-item",t.textContent="dash.js не найден",void this.settingsSubmenu.appendChild(t)}if(!this.dashPlayer){var i=document.createElement("div");return i.className="sigma__dropdown-item",i.textContent="Нет доступных качеств",void this.settingsSubmenu.appendChild(i)}var n=document.createElement("div");n.className="sigma__dropdown-item",n.textContent="Авто",n.dataset.level=-1,n.setAttribute("tabindex","0"),n.addEventListener("click",(function(){e.selectQualityAuto(-1),e.hideSubmenu()})),n.addEventListener("keydown",(function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n.click())})),this.settingsSubmenu.appendChild(n);var s=this.dashPlayer.getBitrateInfoListFor("video"),o=new Map;s.forEach((function(e){var t=e.height?e.height+"p":"".concat(e.bitrate);o.has(t)||o.set(t,e.qualityIndex)})),o.forEach((function(t,i){var n=document.createElement("div");n.className="sigma__dropdown-item",n.textContent=i,n.dataset.level=t,n.setAttribute("tabindex","0"),n.addEventListener("click",(function(){e.selectQualityAuto(parseInt(n.dataset.level)),e.hideSubmenu()})),n.addEventListener("keydown",(function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n.click())})),e.settingsSubmenu.appendChild(n)}))}else if("hls"===this.videoType){if("undefined"==typeof Hls){var a=document.createElement("div");return a.className="sigma__dropdown-item",a.textContent="hls.js не найден",void this.settingsSubmenu.appendChild(a)}if(!this.hls||!this.hls.levels||0===this.hls.levels.length){var r=document.createElement("div");return r.className="sigma__dropdown-item",r.textContent="Нет доступных качеств",void this.settingsSubmenu.appendChild(r)}var d=document.createElement("div");d.className="sigma__dropdown-item",d.textContent="Авто",d.dataset.level=-1,d.setAttribute("tabindex","0"),d.addEventListener("click",(function(){e.selectQualityAuto(-1),e.hideSubmenu()})),d.addEventListener("keydown",(function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),d.click())})),this.settingsSubmenu.appendChild(d);var l=this.hls.levels,u=new Map;l.forEach((function(e,t){var i=e.height?e.height+"p":"".concat(e.bitrate);u.has(i)||u.set(i,t)})),u.forEach((function(t,i){var n=document.createElement("div");n.className="sigma__dropdown-item",n.textContent=i,n.dataset.level=t,n.setAttribute("tabindex","0"),n.addEventListener("click",(function(){e.selectQualityAuto(parseInt(n.dataset.level)),e.hideSubmenu()})),n.addEventListener("keydown",(function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n.click())})),e.settingsSubmenu.appendChild(n)}))}}else{if(!this.selectedTranslation){var c=document.createElement("div");return c.className="sigma__dropdown-item",c.textContent="Нет озвучки",void this.settingsSubmenu.appendChild(c)}Object.keys(this.videoSources[this.selectedTranslation]).sort((function(e,t){return parseInt(t)-parseInt(e)})).forEach((function(t){var i=document.createElement("div");i.className="sigma__dropdown-item",i.textContent=t,i.dataset.quality=t,i.setAttribute("tabindex","0"),i.addEventListener("click",(function(){e.selectQuality(t),e.hideSubmenu()})),i.addEventListener("keydown",(function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),i.click())})),e.settingsSubmenu.appendChild(i)}))}};